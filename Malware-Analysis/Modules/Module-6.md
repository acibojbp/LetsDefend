# Malicious Document Analysis

What is the MD5 value of the `/root/Desktop/QuestionFiles/PO-465514-180820.doc` file?  
`d7e6921bfd008f707ba52dee374ff3db`

What is the file type of the `/home/analyst/PO-465514-180820.doc` file?  
`doc`

![M6-01](https://github.com/acibojbp/LetsDefend/assets/164168280/f68c7e64-0229-4b65-aec2-2fd0dc16a5c4)

Does the file `/root/Desktop/QuestionFiles/PO-465514-180820.doc` contain a VBA macro?   
`Y`

![M6-02](https://github.com/acibojbp/LetsDefend/assets/164168280/1b9728be-21d8-4faa-aec8-d40b7422d00c)

Some malicious activity occurs when the document file `/root/Desktop/QuestionFiles/PO-465514-180820.doc` is opened. What is the macro keyword that enables this?  
`Document_open`

![M6-03](https://github.com/acibojbp/LetsDefend/assets/164168280/a7f6f50e-2c94-4acb-8a0b-e63c43c5abc7)

Who is the author of the file `/root/Desktop/QuestionFiles/PO-465514-180820.doc`?  
`Alexandre Riviere`

What is the last saved time of the `/root/Desktop/QuestionFiles/PO-465514-180820.doc` file?  
`2020-08-18 08:19:00`

![M6-04](https://github.com/acibojbp/LetsDefend/assets/164168280/e7872cf6-b1aa-4f46-80d0-ec9df17db5ff)

The malicious file `Siparis_17.xls` is trying to download files from an address. From which domain is it trying to download the file?  
`hocoso.mobi`

![M6-05](https://github.com/acibojbp/LetsDefend/assets/164168280/61c0a27d-640f-4cc3-a85b-834b1d5a0caf)

How many IOCs are in the `Siparis_17.xls` file according to the Olevba tool?  
`2`

![M6-06](https://github.com/acibojbp/LetsDefend/assets/164168280/609a8a3b-7af2-4d6c-8c67-edf4d24344e9)

 The file `PO-465514-180820.doc` is trying to make a request to a domain ending with `.kz`. What is this domain?  
 `msbc.kz`

![M6-07](https://github.com/acibojbp/LetsDefend/assets/164168280/37f48540-bde5-49a5-87e2-2e42ddf3a50e)

With which Windows tool are the connection requests made? (file:PO-465514-180820.doc)  
`powershell.exe`

![M6-08](https://github.com/acibojbp/LetsDefend/assets/164168280/17f607d9-c7a4-4b63-a444-8a314611418c)

How many addresses does the file send DNS requests to? (file:PO-465514-180820.doc)  
`5`

The `Siparis_17.xls` malware document is trying to download a file. With what name does he want to save the file it is trying to download to the device?  
`6LeGwKmrm.jar`

![M6-09](https://github.com/acibojbp/LetsDefend/assets/164168280/e36e7ed0-acca-4911-956f-96e266c2fdb6)

## Challenges

### Excel 4.0 Macros

Attackers use a function to make the malicious VBA macros they have prepared run when the document is opened. What do attackers change the cell name to to make Excel 4.0 macros work to provide the same functionality?  
`auto_open`

What is the address of the first cell where Excel 4.0 macros will run in the malicious Office document you are analyzing? (Example: {doc1!ab3})  
`doc4!ba7`

![M6C1-01](https://github.com/acibojbp/LetsDefend/assets/164168280/ebd0f5a2-be2f-45ff-83aa-ea9efa4284ab)

Which function is used to start a process in the operating system in the document you are analyzing?  
`exec`

![M6C1-02](https://github.com/acibojbp/LetsDefend/assets/164168280/e50a2d0b-a61f-4529-998c-99da57e71487)

Which LOLBAS tool was used in the Excel 4.0 macros you analyzed? (Format: {xxxx.exe})  
`regsvr32.exe`

What is the name of the registered DLL?  
`iroto.dll`

Since the `rar` file brought along some `dll`s, it's reasonable to think they might be invoked by the macro. We can double-check this suspicion using Hybrid Analysis.

![M6C1-03](https://github.com/acibojbp/LetsDefend/assets/164168280/41f1cfb7-b520-47bd-8710-6b827a74e98c)


What is the username that made the last change to the malicious document?  
`Amanda`

With exiftool, we noticed that the author field is blank, but we do see that the file was last modified by `Amanda`. It's then reasonable to assume that she is also the author.

![M6C1-04](https://github.com/acibojbp/LetsDefend/assets/164168280/a55bf37e-defa-4b7f-a594-d08393d847c3)

Note :

If you encounter the following error while using the `xlmdeobfuscator` tool:

```
[Loading Cells]
Error [deobfuscator.py:3195 process_file(**vars(args))]: 
```

![M6C1-05](https://github.com/acibojbp/LetsDefend/assets/164168280/99fa902a-de3c-449a-929c-d171f092279c)

You can fix it with the following steps:

1. First, locate the `formula.py` file:

`find / -name formula.py 2>/dev/null`

For me, it landed at:

`/usr/local/lib/python3.8/dist-packages/xlrd2/formula.py`

![M6C1-06](https://github.com/acibojbp/LetsDefend/assets/164168280/b86f3917-cc04-4d65-824f-05f44cee8d77)

2. Now, let's dive into the script:

`sudo nano <path>`

3. Look for the `def dump_formula` function. Use `Ctrl + W` in `nano` to search within.
    
4. Adjust `assert bv >= 80` to `assert bv >= 70`.

![M6C1-07](https://github.com/acibojbp/LetsDefend/assets/164168280/6f78b03a-35b7-4dbe-ae1b-c528a9488f5b)
    
6. Save and exit with `Ctrl + X`, `Y`, and Enter.
    
7. Fire up `xlmdeobfuscator` again, but make sure to use `sudo`.

### Malicious Doc

What type of exploit is running as a result of the relevant file running on the victim machine?  
`rtf.exploit`

What is the relevant Exploit CVE code obtained as a result of the analysis?  
`CVE-2017-11882`

![M6-10](https://github.com/acibojbp/LetsDefend/assets/164168280/0fef2b7d-fce8-4eae-8330-0037d640fb51)


![M6-11](https://github.com/acibojbp/LetsDefend/assets/164168280/1a70a822-b129-4ff5-9e6b-3c4c95087eff)

![M6-12](https://github.com/acibojbp/LetsDefend/assets/164168280/12d3c2a0-65a8-4d46-8f93-0e2a91a61914)

> Checking out the extracted object from the `rtf`, it seems to be an `OLE` file, judging by the file signatures.  
> Taking a peek at the hex of the `.bin` file, it looks like it's running some sort of shell code. Let's put this to the test with `scdbg`.

![M6-13](https://github.com/acibojbp/LetsDefend/assets/164168280/e978dd99-da9d-4789-b94e-2baa9968e6ae)

What is the name of the malicious software downloaded from the internet as a result of the file running?  
`jan2.exe`

![M6-14](https://github.com/acibojbp/LetsDefend/assets/164168280/820e7f97-f4bc-40d2-81a0-bee86138ba39)

What is the IP address and port information it communicates with?  
`185.36.74.48:80`

![M6-15](https://github.com/acibojbp/LetsDefend/assets/164168280/f63d56f1-c411-4d1a-bf1f-4cb8bd75b744)

![M6-16](https://github.com/acibojbp/LetsDefend/assets/164168280/b71fe186-817f-4cce-8ef5-0494ee9aa36f)

What is the exe name it drops to disk after it runs?  
`aro.exe`
