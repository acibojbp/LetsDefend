# Malicious VBA

![VirtualBox_REMnux_24_04_2024_15_14_53](https://github.com/acibojbp/LetsDefend/assets/164168280/ce163706-f821-4f74-afa3-a7511d3038cb)

![VirtualBox_REMnux_24_04_2024_15_15_04](https://github.com/acibojbp/LetsDefend/assets/164168280/2ea66436-ea2c-4f11-b119-792de6aa174d)

By using olevba, we can detect obfuscated strings in the script, encoded in hexadecimal format. To improve readability, we can open the script in Visual Studio Code.  

`code invoice.vb`

![VirtualBox_REMnux_24_04_2024_15_35_13](https://github.com/acibojbp/LetsDefend/assets/164168280/5c497d2e-c82b-4f5a-975e-4a5242372592)

As it stands, the script is unreadable. Therefore, we need to deobfuscate it. This can be achieved using the built-in options of olevba.

![VirtualBox_REMnux_24_04_2024_15_35_49](https://github.com/acibojbp/LetsDefend/assets/164168280/143da072-cda2-4924-b215-ebc42b81f001)

Use olevba to deobfuscate and save the output to a file, then open it in Visual Studio Code

`sudo olevba --deobf --reveal invoice.vb > invoice_deobf.vb`  

`code invoice_deobf.vb`

Locate the section displaying the contents labeled `Deobfuscated VBA Strings`.

![VirtualBox_REMnux_24_04_2024_15_34_38](https://github.com/acibojbp/LetsDefend/assets/164168280/8031af68-4485-4d18-92a2-3e02c7a4bee9)

At the bottom of that, you'll find the deobfuscated VBA script.

To remove the remaining 'b' characters, press Ctrl + F to open the Find dialog, then click the arrow on the left side and select 'Replace.' In the 'Find' field, enter 'b', leave the 'Replace' field empty, and then select 'Replace All'.

Once the 'b' characters are removed, you should be able to see all the answers clearly.

![VirtualBox_REMnux_24_04_2024_15_37_25](https://github.com/acibojbp/LetsDefend/assets/164168280/0fc0a23c-fab2-4b54-80b9-c9fe0058ea94)

![VirtualBox_REMnux_24_04_2024_15_39_11](https://github.com/acibojbp/LetsDefend/assets/164168280/67d9f978-b3b0-4826-bbb8-6d883a756902)

The document initiates the download of a payload after the execution, can you tell what website is hosting it?  
`https://tinyurl.com/g2z2gh6f`

What is the filename of the payload (include the extension)?  
`dropped.exe`

What method is it using to establish an HTTP connection between files on the malicious web server?  
`MSXML2.ServerXMLHTTP`

What user-agent string is it using?  
`Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)`

What object does the attacker use to be able to read or write text and binary files?  
`ADODB.Stream`

What is the object the attacker uses for WMI execution? Possibly they are using this to hide the suspicious application running in the background.  
`winmgmts:\\.\root\cimv2:Win32_Process`
