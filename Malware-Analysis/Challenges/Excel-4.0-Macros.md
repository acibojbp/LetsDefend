# Excel 4.0 Macros

Attackers use a function to make the malicious VBA macros they have prepared run when the document is opened. What do attackers change the cell name to to make Excel 4.0 macros work to provide the same functionality?  
`auto_open`

What is the address of the first cell where Excel 4.0 macros will run in the malicious Office document you are analyzing? (Example: {doc1!ab3})  
`doc4!ba7`

![M6C1-01](https://github.com/acibojbp/LetsDefend/assets/164168280/ebd0f5a2-be2f-45ff-83aa-ea9efa4284ab)

Which function is used to start a process in the operating system in the document you are analyzing?  
`exec`

![M6C1-02](https://github.com/acibojbp/LetsDefend/assets/164168280/e50a2d0b-a61f-4529-998c-99da57e71487)

Which LOLBAS tool was used in the Excel 4.0 macros you analyzed? (Format: {xxxx.exe})  
`regsvr32.exe`

What is the name of the registered DLL?  
`iroto.dll`

Since the `rar` file brought along some `dll`s, it's reasonable to think they might be invoked by the macro. We can double-check this suspicion using Hybrid Analysis.

![M6C1-03](https://github.com/acibojbp/LetsDefend/assets/164168280/41f1cfb7-b520-47bd-8710-6b827a74e98c)


What is the username that made the last change to the malicious document?  
`Amanda`

With exiftool, we noticed that the author field is blank, but we do see that the file was last modified by `Amanda`. It's then reasonable to assume that she is also the author.

![M6C1-04](https://github.com/acibojbp/LetsDefend/assets/164168280/a55bf37e-defa-4b7f-a594-d08393d847c3)

Note :

If you encounter the following error while using the `xlmdeobfuscator` tool:

```
[Loading Cells]
Error [deobfuscator.py:3195 process_file(**vars(args))]: 
```

![M6C1-05](https://github.com/acibojbp/LetsDefend/assets/164168280/99fa902a-de3c-449a-929c-d171f092279c)

You can fix it with the following steps:

1. First, locate the `formula.py` file:

`find / -name formula.py 2>/dev/null`

For me, it landed at:

`/usr/local/lib/python3.8/dist-packages/xlrd2/formula.py`

![M6C1-06](https://github.com/acibojbp/LetsDefend/assets/164168280/b86f3917-cc04-4d65-824f-05f44cee8d77)

2. Now, let's dive into the script:

`sudo nano <path>`

3. Look for the `def dump_formula` function. Use `Ctrl + W` in `nano` to search within.
    
4. Adjust `assert bv >= 80` to `assert bv >= 70`.

![M6C1-07](https://github.com/acibojbp/LetsDefend/assets/164168280/6f78b03a-35b7-4dbe-ae1b-c528a9488f5b)
    
6. Save and exit with `Ctrl + X`, `Y`, and Enter.
    
7. Fire up `xlmdeobfuscator` again, but make sure to use `sudo`.
